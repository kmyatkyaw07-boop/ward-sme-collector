<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SME Analyst - Data Collector</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pyidaungsu:wght@400;700&display=swap');
        :root { font-family: 'Inter', 'Pyidaungsu', sans-serif; }
        #main-map { height: 220px; width: 100%; z-index: 10; }
        #review-map { height: 120px; width: 100%; border-radius: 0.75rem; margin-top: 8px; }
        .hidden-el { display: none !important; }
        .chip { transition: all 0.2s; cursor: pointer; border: 1px solid #e2e8f0; }
        .chip.active { background-color: #3730a3; color: white; border-color: #3730a3; transform: scale(0.95); }
        .loader { border-top-color: transparent; border-radius: 50%; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body.modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <header class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-[1000] flex justify-between items-center">
        <h1 class="font-bold flex items-center gap-2 italic">
            <i data-lucide="database"></i> SME ANALYST <span class="text-[10px] bg-amber-500 px-1 rounded text-indigo-900 not-italic">PRO</span>
        </h1>
        <select id="lang-switch" class="bg-indigo-800 text-xs border rounded px-2 py-1 outline-none text-white border-indigo-700">
            <option value="en">English</option>
            <option value="mm" selected>မြန်မာ</option>
        </select>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- Map Control -->
        <section class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
            <div id="main-map"></div>
            <div class="p-3 bg-white flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400" id="coords-display">0.000000, 0.000000</span>
                <button onclick="refreshGPS()" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 active:bg-indigo-200 transition-colors">
                    <i data-lucide="crosshair" class="w-3 h-3"></i> <span data-lang="syncGps">Locate Me</span>
                </button>
            </div>
        </section>

        <!-- Main Form -->
        <form id="collector-form" class="space-y-6">
            <!-- Hidden Fields -->
            <input type="hidden" name="lat" id="inp-lat">
            <input type="hidden" name="lng" id="inp-lng">
            <input type="hidden" name="digital_pay" id="inp-pay">
            <input type="hidden" name="delivery_apps" id="inp-delivery">

            <!-- Basic Info -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-indigo-900 uppercase tracking-widest border-b pb-2 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> Core Business Info
                </h3>
                
                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-1 block" data-lang="labelName">Shop Name</label>
                    <input type="text" name="shop_name" id="shop_name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block" data-lang="labelCategory">Category</label>
                        <select id="cat-main" name="category_main" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none"></select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block" data-lang="labelSubCategory">Sub-type</label>
                        <select id="cat-sub" name="category_sub" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block">Staff Count</label>
                        <select name="staff_size" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm">
                            <option value="1-3">1-3 (Micro)</option>
                            <option value="4-10">4-10 (Small)</option>
                            <option value="11-30">11-30 (Medium)</option>
                            <option value="30+">30+ (Large)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block">Price Tier</label>
                        <select name="price_tier" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm">
                            <option value="Budget">Low (Budget)</option>
                            <option value="Mid">Medium (Mid)</option>
                            <option value="Premium">High (Premium)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Digital Maturity -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-indigo-900 uppercase tracking-widest border-b pb-2 flex items-center gap-2">
                    <i data-lucide="smartphone" class="w-4 h-4"></i> Digital Maturity
                </h3>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-2 block">Accepted Digital Payments</label>
                    <div class="flex flex-wrap gap-2" id="pay-chips">
                        <!-- Chips injected -->
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 mb-2 block">Delivery Platforms</label>
                    <div class="flex flex-wrap gap-2" id="delivery-chips">
                        <!-- Chips injected -->
                    </div>
                </div>
            </div>

            <!-- Future Analysis Fields -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-indigo-900 uppercase tracking-widest border-b pb-2 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4"></i> Deep Analysis Inputs
                </h3>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block">Competitors Nearby</label>
                        <select name="competitor_density" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm">
                            <option value="None">None (Isolated)</option>
                            <option value="Few">1-2 (Low)</option>
                            <option value="Many">3+ (High)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 mb-1 block">Store Visibility</label>
                        <select name="visibility" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-2xl text-sm">
                            <option value="Hidden">Hidden/Alley</option>
                            <option value="Standard">Standard Street</option>
                            <option value="Prime">Prime/Corner</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="button" onclick="prepareReview()" class="w-full bg-indigo-900 text-white font-bold py-5 rounded-3xl shadow-2xl active:scale-95 transition-transform flex items-center justify-center gap-3">
                <i data-lucide="file-check"></i> <span data-lang="btnReview">Review & Store Data</span>
            </button>
        </form>
    </main>

    <!-- Review Modal -->
    <div id="modal" class="hidden-el fixed inset-0 z-[2000] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 bg-indigo-900 text-white shrink-0">
                <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="check-circle-2"></i> Verification</h2>
                <p class="text-[10px] opacity-70">Please check every field before final save.</p>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-3 bg-slate-50">
                <div id="review-map-container">
                    <label class="text-[10px] font-bold text-indigo-500 uppercase">Map Verification</label>
                    <div id="review-map"></div>
                </div>
                <div id="review-list" class="space-y-2">
                    <!-- Summary items -->
                </div>
            </div>

            <div class="p-6 bg-white border-t flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 text-slate-500 font-bold text-sm border border-slate-200 rounded-2xl">Edit</button>
                <button id="submit-final" onclick="performSubmit()" class="flex-[2] py-4 bg-emerald-600 text-white font-bold text-sm rounded-2xl shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="upload-cloud"></i> Save to Cloud
                </button>
            </div>
        </div>
    </div>

    <!-- Success Feedback -->
    <div id="toast" class="hidden-el fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-full shadow-xl font-bold z-[3000] flex items-center gap-2">
        <i data-lucide="check"></i> Records Saved!
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyU3iKTG50czkEg0g58bnrOMZMMWI2o3MDZZwEMSLhanl1k6OX-LebuezlffXcVWy1xEA/exec";
        
        const config = {
            en: {
                payment: ["MMQR", "Kpay", "AYA Pay", "WaveMoney", "True Money", "Cash Only"],
                delivery: ["FoodPanda", "Grab", "Door2Door", "Own Delivery", "None"],
                cats: {
                    "Food & Drink": ["Restaurant", "Cafe", "Bar", "Street Vendor"],
                    "Retail": ["Groceries", "Fashion", "Electronics", "Pharmacy"],
                    "Services": ["Laundry", "Barber", "Repair Shop", "Printing"]
                },
                labels: {
                    syncGps: "Locate Me",
                    labelName: "Shop Name",
                    labelCategory: "Category",
                    labelSubCategory: "Sub-type",
                    btnReview: "Review & Store Data"
                }
            },
            mm: {
                payment: ["MMQR", "Kpay", "AYA Pay", "WaveMoney", "True Money", "ငွေသားသီးသန့်"],
                delivery: ["FoodPanda", "Grab", "Door2Door", "ကိုယ်ပိုင်ပို့ဆောင်ရေး", "မရှိပါ"],
                cats: {
                    "စားသောက်ကုန်": ["စားသောက်ဆိုင်", "ကော်ဖီဆိုင်", "အရက်/ဘီယာ", "လမ်းဘေးဆိုင်"],
                    "အရောင်းဆိုင်": ["ကုန်စုံဆိုင်", "အထည်အလိပ်", "ဖုန်း/အီလက်ထရောနစ်", "ဆေးဆိုင်"],
                    "ဝန်ဆောင်မှု": ["အဝတ်လျှော်", "ဆံပင်ညပ်", "ပြင်ဆင်ရေး", "မိတ္တူ/ပုံနှိပ်"]
                },
                labels: {
                    syncGps: "တည်နေရာယူမည်",
                    labelName: "ဆိုင်အမည်",
                    labelCategory: "အဓိကအမျိုးအစား",
                    labelSubCategory: "အမျိုးအစားခွဲ",
                    btnReview: "စစ်ဆေးပြီး သိမ်းဆည်းမည်"
                }
            }
        };

        let currentLang = 'mm';
        let mainMap, reviewMap, mainMarker, reviewMarker;
        const selectedPay = new Set();
        const selectedDelivery = new Set();

        function updateUI() {
            const langData = config[currentLang];
            
            // Labels
            document.querySelectorAll('[data-lang]').forEach(el => {
                el.innerText = langData.labels[el.getAttribute('data-lang')];
            });

            // Main Category
            const catMain = document.getElementById('cat-main');
            catMain.innerHTML = Object.keys(langData.cats).map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Chips
            renderChips('pay-chips', langData.payment, selectedPay, 'inp-pay');
            renderChips('delivery-chips', langData.delivery, selectedDelivery, 'inp-delivery');
            
            updateSubCats();
            lucide.createIcons();
        }

        function renderChips(containerId, list, setObj, hiddenInputId) {
            const container = document.getElementById(containerId);
            container.innerHTML = list.map(item => `
                <div class="chip px-4 py-2 rounded-xl text-xs font-semibold bg-white ${setObj.has(item) ? 'active' : ''}" 
                     onclick="toggleChip(this, '${item}', '${containerId}', '${hiddenInputId}')">${item}</div>
            `).join('');
        }

        function toggleChip(el, value, containerId, hiddenInputId) {
            const setObj = containerId === 'pay-chips' ? selectedPay : selectedDelivery;
            if (setObj.has(value)) setObj.delete(value);
            else setObj.add(value);
            
            el.classList.toggle('active');
            document.getElementById(hiddenInputId).value = Array.from(setObj).join(', ');
        }

        function updateSubCats() {
            const main = document.getElementById('cat-main').value;
            const sub = document.getElementById('cat-sub');
            const list = config[currentLang].cats[main] || [];
            sub.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function initMaps() {
            mainMap = L.map('main-map').setView([16.8409, 96.1735], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mainMap);
            
            mainMarker = L.marker([16.8409, 96.1735], { draggable: true }).addTo(mainMap);
            mainMarker.on('dragend', () => syncCoords(mainMarker.getLatLng()));
            mainMap.on('click', (e) => {
                mainMarker.setLatLng(e.latlng);
                syncCoords(e.latlng);
            });

            refreshGPS();
        }

        function syncCoords(latlng) {
            document.getElementById('inp-lat').value = latlng.lat.toFixed(6);
            document.getElementById('inp-lng').value = latlng.lng.toFixed(6);
            document.getElementById('coords-display').innerText = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
        }

        function refreshGPS() {
            navigator.geolocation.getCurrentPosition(p => {
                const ll = [p.coords.latitude, p.coords.longitude];
                mainMap.setView(ll, 17);
                mainMarker.setLatLng(ll);
                syncCoords({lat: ll[0], lng: ll[1]});
            }, null, { enableHighAccuracy: true });
        }

        function prepareReview() {
            const name = document.getElementById('shop_name').value.trim();
            if (!name) return document.getElementById('shop_name').classList.add('border-red-500');
            
            const form = document.getElementById('collector-form');
            const data = new FormData(form);
            const list = document.getElementById('review-list');
            
            const summary = [
                ["Name", data.get('shop_name')],
                ["Type", `${data.get('category_main')} > ${data.get('category_sub')}`],
                ["Payments", data.get('digital_pay') || "Cash Only"],
                ["Delivery", data.get('delivery_apps') || "Walk-in Only"],
                ["Scale", `Staff: ${data.get('staff_size')} | Price: ${data.get('price_tier')}`]
            ];

            list.innerHTML = summary.map(([k,v]) => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-start">
                    <span class="text-[9px] font-black text-slate-400 uppercase w-20">${k}</span>
                    <span class="text-xs font-bold text-slate-800 text-right flex-1">${v}</span>
                </div>
            `).join('');

            document.getElementById('modal').classList.remove('hidden-el');
            document.body.classList.add('modal-open');

            // Init Review Map
            const lat = parseFloat(data.get('lat'));
            const lng = parseFloat(data.get('lng'));
            
            setTimeout(() => {
                if (!reviewMap) {
                    reviewMap = L.map('review-map', { zoomControl: false, attributionControl: false }).setView([lat, lng], 17);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(reviewMap);
                    reviewMarker = L.marker([lat, lng]).addTo(reviewMap);
                } else {
                    reviewMap.setView([lat, lng], 17);
                    reviewMarker.setLatLng([lat, lng]);
                    reviewMap.invalidateSize();
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden-el');
            document.body.classList.remove('modal-open');
        }

        async function performSubmit() {
            const btn = document.getElementById('submit-final');
            btn.disabled = true;
            btn.innerHTML = `<div class="loader"></div> Processing...`;

            const data = Object.fromEntries(new FormData(document.getElementById('collector-form')).entries());
            data.timestamp = new Date().toISOString();

            try {
                // Background submission
                fetch(`${API_URL}?${new URLSearchParams(data).toString()}`, { mode: 'no-cors' });
                
                closeModal();
                document.getElementById('toast').classList.remove('hidden-el');
                document.getElementById('collector-form').reset();
                selectedPay.clear();
                selectedDelivery.clear();
                
                setTimeout(() => {
                    document.getElementById('toast').classList.add('hidden-el');
                    updateUI();
                }, 3000);
            } catch (e) {
                alert("Submission failed. Check connection.");
                btn.disabled = false;
                btn.innerText = "Retry Save";
            }
        }

        document.getElementById('cat-main').addEventListener('change', updateSubCats);
        document.getElementById('lang-switch').addEventListener('change', (e) => {
            currentLang = e.target.value;
            updateUI();
        });

        window.onload = () => {
            initMaps();
            updateUI();
        };
    </script>
</body>
</html>
