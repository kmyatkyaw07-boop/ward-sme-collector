<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SME Map Collector - Pro</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
        :root { font-family: 'Inter', 'Pyidaungsu', sans-serif; }
        #map { height: 180px; width: 100%; border-radius: 1rem; z-index: 10; }
        .loader { border-top-color: #ffffff; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal visibility control */
        .hidden-el { display: none !important; }
        .service-chip.active { background-color: #312e81; color: white; border-color: #312e81; }
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        
        /* Prevent body scroll when modal is open */
        body.modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 touch-manipulation">

    <header class="bg-indigo-900 text-white p-4 shadow-lg sticky top-0 z-[1000]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="map-pin"></i> <span data-lang="appTitle">Collector Pro</span>
            </h1>
            <select id="lang-switch" class="bg-indigo-800 text-xs border-none rounded px-2 py-1 outline-none text-white">
                <option value="en">English</option>
                <option value="mm" selected>မြန်မာ</option>
            </select>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-4">
        
        <!-- Map Section -->
        <section class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div id="map"></div>
            <button type="button" onclick="refreshGPS()" class="w-full py-3 text-indigo-700 text-xs font-bold uppercase flex items-center justify-center gap-2 hover:bg-indigo-50 border-t">
                <i data-lucide="locate-fixed" class="w-4 h-4"></i> <span data-lang="syncGps">Sync GPS</span>
            </button>
        </section>

        <!-- Form Section -->
        <section class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6">
            <form id="data-form" class="space-y-4" onsubmit="event.preventDefault();">
                <input type="hidden" name="lat" id="form-lat">
                <input type="hidden" name="long" id="form-long">
                <input type="hidden" name="services" id="final-services">
                <input type="hidden" name="openingHours" id="final-hours">

                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelName">Shop Name</label>
                        <input type="text" name="name" id="shop-name-input" required placeholder="..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelCategory">Main</label>
                            <select id="main-category-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm"></select>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelSubCategory">Sub Type</label>
                            <select id="sub-category-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm"></select>
                        </div>
                    </div>

                    <!-- Time Picker -->
                    <div class="p-3 bg-indigo-50/50 rounded-xl border border-indigo-100">
                        <label class="text-[11px] font-bold text-indigo-700 uppercase block mb-2" data-lang="labelTimeRange">Business Hours</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="time-from" value="09:00" class="flex-1 p-2 rounded-lg border bg-white text-sm outline-none focus:border-indigo-500">
                            <span class="text-slate-400 font-bold">~</span>
                            <input type="time" id="time-to" value="21:00" class="flex-1 p-2 rounded-lg border bg-white text-sm outline-none focus:border-indigo-500">
                        </div>
                    </div>

                    <div id="checklist-container" class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-500 uppercase block" data-lang="labelServices">Services</label>
                        <div id="services-grid" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelPeak">Peak Time</label>
                            <select name="peakTime" id="peak-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm"></select>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelTraffic">Traffic</label>
                            <select name="traffic" id="traffic-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm"></select>
                        </div>
                    </div>
                </div>

                <button type="button" onclick="showReviewModal()" class="w-full bg-indigo-900 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 mt-4">
                    <i data-lucide="save" class="w-5 h-5"></i> <span data-lang="btnReview">Record & Review</span>
                </button>
            </form>
        </section>
    </main>

    <!-- Final Review Modal (Hidden by default) -->
    <div id="review-modal" class="hidden-el fixed inset-0 z-[2000] modal-overlay flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden max-h-[85vh] flex flex-col animate-in slide-in-from-bottom duration-300">
            <div class="bg-indigo-900 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="clipboard-check"></i> Final Review</h3>
                <button onclick="closeModal()" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
            </div>
            
            <div id="review-content" class="p-6 overflow-y-auto space-y-4 text-sm bg-slate-50">
                <!-- Data will be injected here -->
            </div>

            <div class="p-5 bg-white border-t flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 border border-slate-300 rounded-xl font-bold text-slate-600 active:bg-slate-100">
                    Edit Data
                </button>
                <button id="final-submit-btn" onclick="submitData()" class="flex-[1.5] py-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:bg-emerald-700">
                    <i data-lucide="send" class="w-5 h-5"></i> Confirm & Send
                </button>
            </div>
        </div>
    </div>

    <!-- Success Feedback -->
    <div id="success-toast" class="hidden-el fixed bottom-24 left-1/2 -translate-x-1/2 z-[3000] bg-emerald-600 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-2 font-bold animate-bounce">
        <i data-lucide="check-circle"></i> Data Sent Successfully!
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyU3iKTG50czkEg0g58bnrOMZMMWI2o3MDZZwEMSLhanl1k6OX-LebuezlffXcVWy1xEA/exec";

        const categoryData = {
            en: {
                "Food & Beverage": {
                    "Restaurant": ["Aircon", "Delivery", "Alcohol/Beer", "Outdoor Seating"],
                    "Tea Shop": ["Snacks/Cake", "TV/Live Sport", "Breakfast Menu", "Fast Service"],
                    "Street Food": ["Takeaway Only", "Morning Open", "Night Open", "Seating Available"]
                },
                "Health & Beauty": {
                    "Beauty Salon": ["Hair Cut", "Nail Art", "Facial", "Spa/Massage"],
                    "Tailoring": ["Design Consult", "Express Stitch", "Training Class", "Fabric Store"],
                    "Pharmacy": ["Home Delivery", "Clinic Attached", "Counseling", "OTC Only"]
                },
                "Jewelry & Value": {
                    "Gold Shop": ["Buy/Sell", "Exchange", "Certified", "Repair"],
                    "Goldsmith (Nawali)": ["Polishing", "Custom Mold", "Stone Setting", "Quick Fix"]
                }
            },
            mm: {
                "အစားအသောက်": {
                    "စားသောက်ဆိုင်": ["အဲကွန်း", "ပို့ဆောင်ရေး", "အရက်/ဘီယာ", "ပြင်ပထိုင်ခုံ"],
                    "လက်ဖက်ရည်ဆိုင်": ["မုန့်မျိုးစုံ", "TV (ဘောလုံးပွဲ)", "နံနက်စာ", "အမြန်ဝန်ဆောင်မှု"],
                    "လမ်းဘေးဆိုင်": ["ပါဆယ်သီးသန့်", "နံနက်ပိုင်းဖွင့်", "ညပိုင်းဖွင့်", "ထိုင်စားရနိုင်သည်"]
                },
                "ကျန်းမာရေးနှင့်အလှအပ": {
                    "အလှပြင်ဆိုင်": ["ဆံပင်ညပ်", "လက်သည်းခြေသည်း", "မျက်နှာပေါင်းတင်", "အနှိပ်/စပါး"],
                    "အပ်ချုပ်ဆိုင်": ["ဒီဇိုင်းထုတ်ပေးခြင်း", "အမြန်ချုပ်", "သင်တန်းပေးခြင်း", "ပိတ်စရောင်းခြင်း"],
                    "ဆေးဆိုင်": ["အိမ်အရောက်ပို့", "ဆေးခန်းတွဲလျက်", "ကျန်းမာရေးအကြံပေး", "ဆေးညွှန်းမလို"]
                },
                "ရွှေနှင့်ရတနာ": {
                    "ရွှေဆိုင်": ["ရောင်းဝယ်ရေး", "အလဲအထပ်", "အာမခံချက်ပါခြင်း", "ပြင်ဆင်ခြင်း"],
                    "အရောင်တင်/ပန်းထိမ်း": ["အရောင်တင်", "အထည်ဆန်းသွန်း", "ကျောက်စီခြင်း", "အမြန်ပြင်"]
                }
            }
        };

        const translations = {
            en: {
                appTitle: "Collector Pro",
                syncGps: "Update GPS Location",
                labelName: "Shop Name",
                labelCategory: "Category",
                labelSubCategory: "Sub Type",
                labelServices: "Services",
                labelTimeRange: "Business Hours",
                labelPeak: "Peak Time",
                labelTraffic: "Traffic",
                btnReview: "Record & Review",
                peak: ["Morning", "Afternoon", "Evening"],
                traffic: ["Low", "Medium", "High"]
            },
            mm: {
                appTitle: "ကောက်ယူရေး Pro",
                syncGps: "တည်နေရာ ပြန်ယူရန်",
                labelName: "ဆိုင်အမည်",
                labelCategory: "အဓိကအမျိုးအစား",
                labelSubCategory: "အမျိုးအစားခွဲ",
                labelServices: "ဝန်ဆောင်မှုများ",
                labelTimeRange: "ဖွင့်ချိန်/ပိတ်ချိန်",
                labelPeak: "လူစည်ချိန်",
                labelTraffic: "လူစည်ကားမှု",
                btnReview: "စစ်ဆေးပြီး သိမ်းမည်",
                peak: ["နံနက်ပိုင်း", "နေ့လည်ပိုင်း", "ညနေပိုင်း"],
                traffic: ["နည်းပါး", "အလယ်အလတ်", "စည်ကား"]
            }
        };

        let currentLang = localStorage.getItem('app_lang') || 'mm';
        let selectedServices = new Set();
        let map, marker;

        function updateUI() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                el.innerText = t[key];
            });

            const mainCats = Object.keys(categoryData[currentLang]);
            const mainSelect = document.getElementById('main-category-select');
            mainSelect.innerHTML = mainCats.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            updateSubCategories();
            updateSelect('peak-select', t.peak);
            updateSelect('traffic-select', t.traffic);
            lucide.createIcons();
        }

        function updateSubCategories() {
            const mainCat = document.getElementById('main-category-select').value;
            const subSelect = document.getElementById('sub-category-select');
            const subs = Object.keys(categoryData[currentLang][mainCat] || {});
            subSelect.innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
            updateServiceChecklist();
        }

        function updateServiceChecklist() {
            const mainCat = document.getElementById('main-category-select').value;
            const subCat = document.getElementById('sub-category-select').value;
            const grid = document.getElementById('services-grid');
            const services = categoryData[currentLang][mainCat][subCat] || [];
            selectedServices.clear();
            grid.innerHTML = services.map(s => `
                <div class="service-chip px-3 py-1.5 rounded-full border border-slate-300 text-xs font-medium bg-white text-slate-600 cursor-pointer transition-all active:scale-90" 
                     onclick="toggleService(this, '${s}')">${s}</div>
            `).join('');
            document.getElementById('final-services').value = "";
        }

        function toggleService(el, service) {
            if (selectedServices.has(service)) {
                selectedServices.delete(service);
                el.classList.remove('active');
            } else {
                selectedServices.add(service);
                el.classList.add('active');
            }
            document.getElementById('final-services').value = Array.from(selectedServices).join(', ');
        }

        function updateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function initMap() {
            map = L.map('map').setView([16.7983, 96.1738], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            refreshGPS();
            map.on('click', (e) => updateMarker(e.latlng.lat, e.latlng.lng));
        }

        function updateMarker(lat, lng, center = false) {
            if (marker) marker.setLatLng([lat, lng]);
            else {
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                marker.on('dragend', () => setCoords(marker.getLatLng().lat, marker.getLatLng().lng));
            }
            if (center) map.setView([lat, lng], 17);
            setCoords(lat, lng);
        }

        function setCoords(lat, lng) {
            document.getElementById('form-lat').value = parseFloat(lat).toFixed(6);
            document.getElementById('form-long').value = parseFloat(lng).toFixed(6);
        }

        function refreshGPS() {
            navigator.geolocation.getCurrentPosition(
                pos => updateMarker(pos.coords.latitude, pos.coords.longitude, true),
                null, { enableHighAccuracy: true }
            );
        }

        function showReviewModal() {
            const nameInput = document.getElementById('shop-name-input');
            const name = nameInput.value.trim();
            
            if (!name) {
                nameInput.classList.add('border-red-500');
                nameInput.focus();
                return;
            }
            nameInput.classList.remove('border-red-500');

            const from = document.getElementById('time-from').value;
            const to = document.getElementById('time-to').value;
            const hoursStr = `${from} - ${to}`;
            document.getElementById('final-hours').value = hoursStr;

            const reviewContent = document.getElementById('review-content');
            const data = [
                { label: "Shop Name", val: name },
                { label: "Category", val: `${document.getElementById('main-category-select').value} (${document.getElementById('sub-category-select').value})` },
                { label: "Opening Hours", val: hoursStr },
                { label: "Services", val: document.getElementById('final-services').value || "None" },
                { label: "Crowd Details", val: `${document.getElementById('peak-select').value} | Traffic: ${document.getElementById('traffic-select').value}` },
                { label: "Location", val: `${document.getElementById('form-lat').value}, ${document.getElementById('form-long').value}` }
            ];

            reviewContent.innerHTML = data.map(item => `
                <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    <span class="text-[10px] text-indigo-400 font-bold uppercase block mb-1">${item.label}</span>
                    <span class="text-slate-800 font-bold text-sm">${item.val}</span>
                </div>
            `).join('');

            document.getElementById('review-modal').classList.remove('hidden-el');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('review-modal').classList.add('hidden-el');
            document.body.classList.remove('modal-open');
        }

        async function submitData() {
            const btn = document.getElementById('final-submit-btn');
            btn.disabled = true;
            btn.innerHTML = `<div class="loader w-5 h-5 border-2 rounded-full"></div> Sending...`;

            const form = document.getElementById('data-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.timestamp = new Date().toLocaleString();

            try {
                // Send data using GET (JSONP style for no-cors)
                await fetch(`${WEB_APP_URL}?${new URLSearchParams(data).toString()}`, { method: 'GET', mode: 'no-cors' });
                
                closeModal();
                const toast = document.getElementById('success-toast');
                toast.classList.remove('hidden-el');
                form.reset();
                
                setTimeout(() => {
                    toast.classList.add('hidden-el');
                    updateUI();
                }, 3000);
            } catch (err) {
                alert("Network error. Please try again.");
                btn.disabled = false;
                btn.innerHTML = "Confirm & Send";
            }
        }

        // Event Listeners
        document.getElementById('main-category-select').addEventListener('change', updateSubCategories);
        document.getElementById('sub-category-select').addEventListener('change', updateServiceChecklist);
        document.getElementById('lang-switch').addEventListener('change', (e) => {
            currentLang = e.target.value;
            localStorage.setItem('app_lang', currentLang);
            updateUI();
        });

        // Initialize
        window.onload = () => {
            initMap();
            updateUI();
        };
    </script>
</body>
</html>
