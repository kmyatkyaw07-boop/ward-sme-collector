<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SME Map Collector - Kyaukmyaung</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
        
        :root { font-family: 'Inter', 'Pyidaungsu', sans-serif; }
        #map { height: 200px; width: 100%; border-radius: 1rem; z-index: 10; }
        .loader { border-top-color: #ffffff; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, select, textarea { font-size: 16px !important; }
        .hidden-el { display: none; }
        .service-chip { transition: all 0.2s; cursor: pointer; }
        .service-chip.active { background-color: #312e81; color: white; border-color: #312e81; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 touch-manipulation">

    <header class="bg-indigo-900 text-white p-4 shadow-lg sticky top-0 z-[1000]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="map-pin"></i> <span data-lang="appTitle">Kyaukmyaung Engine</span>
            </h1>
            <div class="flex items-center gap-3">
                <select id="lang-switch" class="bg-indigo-800 text-xs border-none rounded px-2 py-1 outline-none text-white">
                    <option value="en">English</option>
                    <option value="mm">မြန်မာ</option>
                </select>
                <div id="status-dot" class="w-3 h-3 bg-emerald-500 rounded-full border-2 border-white"></div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-4">
        
        <!-- Map Section -->
        <section class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <div id="map"></div>
            <div class="p-3 grid grid-cols-2 gap-2 bg-slate-50">
                <div class="bg-white p-2 rounded-lg border border-slate-200 text-center">
                    <span class="text-[9px] font-bold text-slate-400 block uppercase">Lat</span>
                    <input type="number" id="lat" class="bg-transparent text-xs font-mono outline-none w-full text-center" readonly>
                </div>
                <div class="bg-white p-2 rounded-lg border border-slate-200 text-center">
                    <span class="text-[9px] font-bold text-slate-400 block uppercase">Long</span>
                    <input type="number" id="long" class="bg-transparent text-xs font-mono outline-none w-full text-center" readonly>
                </div>
            </div>
            <button type="button" onclick="refreshGPS()" class="w-full py-3 text-indigo-700 text-[11px] font-bold uppercase flex items-center justify-center gap-2 hover:bg-indigo-50 border-t">
                <i data-lucide="locate-fixed" class="w-4 h-4"></i> <span data-lang="syncGps">Sync My GPS</span>
            </button>
        </section>

        <!-- Form Section -->
        <section class="bg-white rounded-2xl shadow-xl border border-slate-200 p-6">
            <form id="data-form" class="space-y-4">
                <input type="hidden" name="lat" id="form-lat">
                <input type="hidden" name="long" id="form-long">
                <input type="hidden" name="services" id="final-services">
                
                <div class="space-y-4">
                    <!-- Shop Name -->
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelName">Shop Name</label>
                        <input type="text" name="name" id="shop-name-input" required placeholder="..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-500">
                    </div>

                    <!-- Category & Subcategory -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelCategory">Main Category</label>
                            <select id="main-category-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            </select>
                            <input type="hidden" name="category" id="final-category">
                        </div>
                        <div id="sub-category-wrapper">
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelSubCategory">Sub Category</label>
                            <select id="sub-category-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            </select>
                            <input type="hidden" name="subCategory" id="final-subcategory">
                        </div>
                    </div>

                    <!-- Service Checklist (Dynamic) -->
                    <div id="checklist-container" class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-500 uppercase block" data-lang="labelServices">Available Services</label>
                        <div id="services-grid" class="flex flex-wrap gap-2">
                            <!-- Chips injected here -->
                        </div>
                    </div>

                    <!-- Detail Info Collection -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelHours">Opening Hours</label>
                            <input type="text" name="openingHours" placeholder="e.g. 9am - 9pm" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelPeak">Peak Hours</label>
                            <select name="peakTime" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                                <option value="Morning">Morning</option>
                                <option value="Afternoon">Afternoon</option>
                                <option value="Evening">Evening/Night</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelTarget">Target Customer</label>
                            <select name="target" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                                <option value="Residents">Local Residents</option>
                                <option value="Workers">Office Workers</option>
                                <option value="Students">Students</option>
                                <option value="General">General Public</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelTraffic">Traffic</label>
                            <select name="traffic" id="traffic-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold">
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[11px] font-bold text-slate-500 uppercase block mb-1" data-lang="labelRemark">Remarks / Special Feature</label>
                    <textarea name="remark" id="remark-input" placeholder="Any unique features..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none min-h-[60px] text-sm"></textarea>
                </div>

                <button type="submit" id="submit-btn" 
                    class="w-full bg-indigo-900 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-5 h-5"></i> <span data-lang="btnSave">Save Record</span>
                </button>
            </form>
        </section>

        <div id="message-box" class="hidden-el p-4 rounded-xl text-center text-sm font-medium"></div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwWtQRWZvhiADEKhmDrKocb3LT2qK7opcZDkBpibLsTh6m5huEX6bWrk3gCB4khtRcDjA/exec";

        const categoryData = {
            en: {
                "Food & Beverage": {
                    "Restaurant": ["Aircon", "Delivery", "Alcohol/Beer", "Outdoor Seating"],
                    "Tea Shop": ["Snacks/Cake", "TV/Live Sport", "Breakfast Menu", "Fast Service"],
                    "Street Food": ["Takeaway Only", "Morning Open", "Night Open", "Seating Available"]
                },
                "Health & Beauty": {
                    "Beauty Salon": ["Hair Cut", "Nail Art", "Facial", "Spa/Massage"],
                    "Tailoring": ["Design Consult", "Express Stitch", "Training Class", "Fabric Store"],
                    "Pharmacy": ["Home Delivery", "Clinic Attached", "Counseling", "OTC Only"],
                    "Fitness/Gym": ["Trainer", "Yoga", "Shower", "Supplements"]
                },
                "Jewelry & Value": {
                    "Gold Shop": ["Buy/Sell", "Exchange", "Certified", "Repair"],
                    "Goldsmith (Nawali)": ["Polishing", "Custom Mold", "Stone Setting", "Quick Fix"]
                },
                "Services": {
                    "Banking/ATM": ["24hr ATM", "Deposit Machine", "Customer Service", "Currency Exchange"],
                    "IT & Printing": ["Copy/Print", "Typing", "PC Repair", "Lamination"],
                    "Maintenance": ["Aircon Service", "Fridge Repair", "Electrician", "Plumbing"]
                }
            },
            mm: {
                "အစားအသောက်": {
                    "စားသောက်ဆိုင်": ["အဲကွန်း", "ပို့ဆောင်ရေး", "အရက်/ဘီယာ", "ပြင်ပထိုင်ခုံ"],
                    "လက်ဖက်ရည်ဆိုင်": ["မုန့်မျိုးစုံ", "TV (ဘောလုံးပွဲ)", "နံနက်စာ", "အမြန်ဝန်ဆောင်မှု"],
                    "လမ်းဘေးဆိုင်": ["ပါဆယ်သီးသန့်", "နံနက်ပိုင်းဖွင့်", "ညပိုင်းဖွင့်", "ထိုင်စားရနိုင်သည်"]
                },
                "ကျန်းမာရေးနှင့်အလှအပ": {
                    "အလှပြင်ဆိုင်": ["ဆံပင်ညှပ်", "လက်သည်းခြေသည်း", "မျက်နှာပေါင်းတင်", "အနှိပ်/စပါး"],
                    "အပ်ချုပ်ဆိုင်": ["ဒီဇိုင်းထုတ်ပေးခြင်း", "အမြန်ချုပ်", "သင်တန်းပေးခြင်း", "ပိတ်စရောင်းခြင်း"],
                    "ဆေးဆိုင်": ["အိမ်အရောက်ပို့", "ဆေးခန်းတွဲလျက်", "ကျန်းမာရေးအကြံပေး", "ဆေးညွှန်းမလို"],
                    "ကြံ့ခိုင်ရေး": ["နည်းပြရှိသည်", "ယောဂ", "ရေချိုးခန်း", "အားဖြည့်စာ"]
                },
                "ရွှေနှင့်ရတနာ": {
                    "ရွှေဆိုင်": ["ရောင်းဝယ်ရေး", "အလဲအထပ်", "အာမခံချက်ပါခြင်း", "ပြင်ဆင်ခြင်း"],
                    "အရောင်တင်/ပန်းထိမ်း": ["အရောင်တင်", "အထည်ဆန်းသွန်း", "ကျောက်စီခြင်း", "အမြန်ပြင်"]
                },
                "ဝန်ဆောင်မှု": {
                    "ဘဏ်/ATM": ["ATM (၂၄ နာရီ)", "ငွေသွင်းစက်", "ကောင်တာဝန်ဆောင်မှု", "နိုင်ငံခြားငွေ"],
                    "အိုင်တီနှင့်ပုံနှိပ်": ["မိတ္တူ/ပရင့်", "စာစီစာရိုက်", "ကွန်ပျူတာပြင်", "ပလတ်စတစ်လောင်း"],
                    "ပြုပြင်ထိန်းသိမ်းရေး": ["အဲကွန်းပြင်", "ရေခဲသေတ္တာပြင်", "လျှပ်စစ်ပြင်", "ရေပိုက်ပြင်"]
                }
            }
        };

        const translations = {
            en: {
                appTitle: "Kyaukmyaung Engine",
                syncGps: "Sync My GPS",
                labelName: "Shop Name",
                labelCategory: "Category",
                labelSubCategory: "Sub Type",
                labelServices: "Services Checklist",
                labelHours: "Opening Hours",
                labelPeak: "Peak Hours",
                labelTarget: "Target Customer",
                labelTraffic: "Traffic Level",
                labelRemark: "Remarks / Features",
                btnSave: "Save Record",
                msgSuccess: "Data Saved Successfully!",
                msgError: "Error: Could not save data",
                traffic: ["Low", "Medium", "High"]
            },
            mm: {
                appTitle: "ကျောက်မြောင်းဒေတာအင်ဂျင်",
                syncGps: "တည်နေရာရယူရန်",
                labelName: "ဆိုင်အမည်",
                labelCategory: "အဓိက",
                labelSubCategory: "အမျိုးအစားခွဲ",
                labelServices: "ရရှိနိုင်သော ဝန်ဆောင်မှုများ",
                labelHours: "ဖွင့်ချိန်/ပိတ်ချိန်",
                labelPeak: "လူစည်ကားချိန်",
                labelTarget: "ဖောက်သည်အမျိုးအစား",
                labelTraffic: "လူစည်ကားမှု",
                labelRemark: "မှတ်ချက်/ထူးခြားချက်",
                btnSave: "ဒေတာသိမ်းဆည်းမည်",
                msgSuccess: "ဒေတာသိမ်းဆည်းမှု အောင်မြင်ပါသည်။",
                msgError: "အမှားအယွင်းရှိနေပါသည်။",
                traffic: ["နည်းပါး", "အလယ်အလတ်", "စည်ကား"]
            }
        };

        let currentLang = localStorage.getItem('app_lang') || 'mm';
        let selectedServices = new Set();

        function updateUI() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                el.innerText = t[key];
            });

            const mainCats = Object.keys(categoryData[currentLang]);
            const mainSelect = document.getElementById('main-category-select');
            mainSelect.innerHTML = mainCats.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            updateSubCategories();
            updateSelect('traffic-select', t.traffic);
            lucide.createIcons();
        }

        function updateSubCategories() {
            const mainCat = document.getElementById('main-category-select').value;
            const subSelect = document.getElementById('sub-category-select');
            const subs = Object.keys(categoryData[currentLang][mainCat] || {});
            
            subSelect.innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
            updateServiceChecklist();
        }

        function updateServiceChecklist() {
            const mainCat = document.getElementById('main-category-select').value;
            const subCat = document.getElementById('sub-category-select').value;
            const grid = document.getElementById('services-grid');
            
            const services = categoryData[currentLang][mainCat][subCat] || [];
            selectedServices.clear();
            
            grid.innerHTML = services.map(s => `
                <div class="service-chip px-3 py-1 rounded-full border border-slate-300 text-xs font-medium bg-white text-slate-600" 
                     onclick="toggleService(this, '${s}')">
                    ${s}
                </div>
            `).join('');
        }

        function toggleService(el, service) {
            if (selectedServices.has(service)) {
                selectedServices.delete(service);
                el.classList.remove('active');
            } else {
                selectedServices.add(service);
                el.classList.add('active');
            }
            document.getElementById('final-services').value = Array.from(selectedServices).join(', ');
        }

        function updateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        // Listeners
        document.getElementById('main-category-select').addEventListener('change', updateSubCategories);
        document.getElementById('sub-category-select').addEventListener('change', updateServiceChecklist);
        document.getElementById('lang-switch').addEventListener('change', (e) => {
            currentLang = e.target.value;
            localStorage.setItem('app_lang', currentLang);
            updateUI();
        });

        // Map
        let map = L.map('map').setView([16.7983, 96.1738], 15); // Centered near Kyaukmyaung
        let marker;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function updateMarker(lat, lng, center = false) {
            if (marker) marker.setLatLng([lat, lng]);
            else {
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                marker.on('dragend', () => setCoords(marker.getLatLng().lat, marker.getLatLng().lng));
            }
            if (center) map.setView([lat, lng], 17);
            setCoords(lat, lng);
        }

        function setCoords(lat, lng) {
            const latVal = parseFloat(lat).toFixed(6);
            const lngVal = parseFloat(lng).toFixed(6);
            document.getElementById('lat').value = latVal;
            document.getElementById('long').value = lngVal;
            document.getElementById('form-lat').value = latVal;
            document.getElementById('form-long').value = lngVal;
        }

        map.on('click', (e) => updateMarker(e.latlng.lat, e.latlng.lng));

        function refreshGPS() {
            navigator.geolocation.getCurrentPosition(
                pos => updateMarker(pos.coords.latitude, pos.coords.longitude, true),
                null, { enableHighAccuracy: true }
            );
        }

        // Submission
        const form = document.getElementById('data-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            document.getElementById('final-category').value = document.getElementById('main-category-select').value;
            document.getElementById('final-subcategory').value = document.getElementById('sub-category-select').value;

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = `<div class="loader w-5 h-5 border-2 rounded-full"></div>`;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.timestamp = new Date().toLocaleString();

            try {
                // Using GET with query params as common for simple Google Apps Script setups
                await fetch(`${WEB_APP_URL}?${new URLSearchParams(data).toString()}`, { method: 'GET', mode: 'no-cors' });
                
                const msgBox = document.getElementById('message-box');
                msgBox.innerText = translations[currentLang].msgSuccess;
                msgBox.className = "p-4 rounded-xl text-center bg-emerald-100 text-emerald-700 block shadow-sm";
                
                form.reset();
                selectedServices.clear();
                setTimeout(() => msgBox.className = "hidden-el", 4000);
                refreshGPS();
            } catch (err) {
                alert(translations[currentLang].msgError);
            } finally {
                btn.disabled = false;
                updateUI();
            }
        });

        document.getElementById('lang-switch').value = currentLang;
        updateUI();
        refreshGPS();
    </script>
</body>
</html>
